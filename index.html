<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Â§©Á©∫Â∞èÂ•áÂÖµ - Super Pilot Web</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser-arcade-physics.min.js"></script>
    <style>
        body { margin: 0; background: #000; overflow: hidden; display: flex; justify-content: center; align-items: center; height: 100vh; }
        #game-container { box-shadow: 0 0 20px rgba(0,0,0,0.5); }
    </style>
</head>
<body>
    <div id="game-container"></div>

<script>
/**
 * ÈÅäÊà≤Ë®≠ÂÆöËàáÂÖ®ÂüüËÆäÊï∏
 */
const config = {
    type: Phaser.AUTO,
    parent: 'game-container',
    width: 450,
    height: 800,
    scale: {
        mode: Phaser.Scale.FIT,
        autoCenter: Phaser.Scale.CENTER_BOTH
    },
    physics: {
        default: 'arcade',
        arcade: { gravity: { y: 0 }, debug: false }
    },
    scene: [BootScene, SelectScene, StageScene, PlayScene]
};

let gameState = {
    selectedChar: 'red', // 'red' or 'purple'
    selectedStage: 'canyon', // 'plain', 'ocean', 'canyon'
    nukes: 3,
    score: 0
};

const game = new Phaser.Game(config);

/** 1. Ë≥áÊ∫êËºâÂÖ•Â†¥ÊôØ **/
class BootScene extends Phaser.Scene {
    constructor() { super('BootScene'); }
    preload() {
        this.add.text(225, 400, 'Loading...', { fontSize: '32px', fill: '#fff' }).setOrigin(0.5);
        // ‰ΩøÁî® Placeholder Ê®°Êì¨ÂúñÂΩ¢ÔºåÊ≠£ÂºèÁôºÂ∏ÉÂª∫Ë≠∞ÊõøÊèõÊàêÁúüÂØ¶ÂúñÁâá
        this.load.image('bullet', 'https://labs.phaser.io/assets/sprites/bullets/bullet1.png');
        this.load.image('nuke_icon', 'https://labs.phaser.io/assets/sprites/fuji.png'); // Ê®°Êì¨Ê†∏ÂΩàÂúñÁ§∫
        this.load.image('spark', 'https://labs.phaser.io/assets/particles/blue.png');
    }
    create() { this.scene.start('SelectScene'); }
}

/** 2. ËßíËâ≤ÈÅ∏ÊìáÂ†¥ÊôØ **/
class SelectScene extends Phaser.Scene {
    constructor() { super('SelectScene'); }
    create() {
        this.add.text(225, 100, 'Ë´ãÈÅ∏ÊìáËßíËâ≤', { fontSize: '40px', fontStyle: 'bold', fill: '#fff' }).setOrigin(0.5);
        
        const redBtn = this.add.text(225, 300, 'üöÅ Á¥ÖËâ≤ÊïëË≠∑ÂÖµ (ÊîªÈÄüÂûã)', { fontSize: '28px', backgroundColor: '#e74c3c', padding: 15 }).setOrigin(0.5).setInteractive();
        const purpleBtn = this.add.text(225, 450, 'üöÅ Á¥´Ëâ≤ÈÜ´ÁôÇÂÖµ (ÁØÑÂúçÂûã)', { fontSize: '28px', backgroundColor: '#8e44ad', padding: 15 }).setOrigin(0.5).setInteractive();

        redBtn.on('pointerdown', () => { gameState.selectedChar = 'red'; this.scene.start('StageScene'); });
        purpleBtn.on('pointerdown', () => { gameState.selectedChar = 'purple'; this.scene.start('StageScene'); });
    }
}

/** 3. ÈóúÂç°ÈÅ∏ÊìáÂ†¥ÊôØ **/
class StageScene extends Phaser.Scene {
    constructor() { super('StageScene'); }
    create() {
        this.add.text(225, 100, 'ÈÅ∏ÊìáÈóúÂç°', { fontSize: '40px', fill: '#fff' }).setOrigin(0.5);
        const stages = [
            { id: 'plain', name: 'üåæ Âπ≥ÂéüÈóú', color: '#27ae60' },
            { id: 'ocean', name: 'üåä Êµ∑Ê¥ãÈóú', color: '#2980b9' },
            { id: 'canyon', name: 'üèú Â≥ΩË∞∑Èóú', color: '#d35400' }
        ];

        stages.forEach((s, i) => {
            let btn = this.add.text(225, 250 + (i * 120), s.name, { fontSize: '32px', backgroundColor: s.color, padding: 20 }).setOrigin(0.5).setInteractive();
            btn.on('pointerdown', () => { gameState.selectedStage = s.id; this.scene.start('PlayScene'); });
        });
    }
}

/** 4. ‰∏ªÈÅäÊà≤Â†¥ÊôØ **/
class PlayScene extends Phaser.Scene {
    constructor() { super('PlayScene'); }

    create() {
        const { width, height } = this.scale;
        this.isBossTime = false;
        gameState.nukes = 3;

        // ËÉåÊôØ
        const bgColors = { plain: 0x2ecc71, ocean: 0x3498db, canyon: 0xe67e22 };
        this.bg = this.add.tileSprite(width/2, height/2, width, height, 'spark').setTint(bgColors[gameState.selectedStage] || 0x34495e);

        // Áé©ÂÆ∂È£õÊ©ü
        this.player = this.physics.add.sprite(width / 2, height - 100, 'nuke_icon').setScale(1.5);
        this.player.setTint(gameState.selectedChar === 'red' ? 0xff0000 : 0xcc00ff);
        this.player.setCollideWorldBounds(true);

        // Áæ§ÁµÑ
        this.bullets = this.physics.add.group();
        this.enemies = this.physics.add.group();
        this.bossGroup = this.physics.add.group();

        // ÈçµÁõ§ËàáÊªëÈº†
        this.cursors = this.input.keyboard.createCursorKeys();
        
        // Ëá™ÂãïÈÄ£Â∞Ñ
        this.time.addEvent({
            delay: 150,
            callback: () => { if(this.input.activePointer.isDown) this.fire(); },
            loop: true
        });

        // Êïµ‰∫∫ÁîüÊàê
        this.spawnTimer = this.time.addEvent({
            delay: 1000,
            callback: this.spawnEnemy,
            callbackScope: this,
            loop: true
        });

        // UI: Ê†∏ÂΩàËàáÂàÜÊï∏
        this.scoreLabel = this.add.text(20, 20, 'SCORE: 0', { fontSize: '24px', fill: '#fff', stroke: '#000', strokeThickness: 4 });
        this.nukeUI = this.add.group();
        this.updateNukeUI();

        // Á¢∞Êíû
        this.physics.add.overlap(this.bullets, this.enemies, (bullet, enemy) => {
            enemy.destroy(); bullet.destroy();
            gameState.score += 100;
            this.scoreLabel.setText('SCORE: ' + gameState.score);
        });

        // ÈÅäÊà≤ÊµÅÁ®ãÊéßÂà∂Ôºö20ÁßíÂæåÂá∫ Boss
        this.time.delayedCall(20000, this.prepareBoss, [], this);
    }

    update() {
        this.bg.tilePositionY -= 2;

        // Áé©ÂÆ∂ÁßªÂãï
        const speed = 300;
        this.player.setVelocity(0);
        if (this.cursors.left.isDown) this.player.setVelocityX(-speed);
        else if (this.cursors.right.isDown) this.player.setVelocityX(speed);
        if (this.cursors.up.isDown) this.player.setVelocityY(-speed);
        else if (this.cursors.down.isDown) this.player.setVelocityY(speed);
    }

    fire() {
        let b = this.bullets.create(this.player.x, this.player.y - 20, 'bullet');
        b.setVelocityY(-600);
        b.setTint(0xf1c40f);
    }

    spawnEnemy() {
        if (this.isBossTime) return;
        let x = Phaser.Math.Between(50, 400);
        let e = this.enemies.create(x, -50, 'nuke_icon').setTint(0x00ff00);
        e.setVelocityY(Phaser.Math.Between(150, 300));
    }

    updateNukeUI() {
        this.nukeUI.clear(true, true);
        for (let i = 0; i < gameState.nukes; i++) {
            let n = this.add.image(400 - (i * 45), 40, 'nuke_icon').setScale(0.8).setInteractive();
            n.setTint(0xffd700);
            n.on('pointerdown', () => this.useNuke());
            this.nukeUI.add(n);
        }
    }

    useNuke() {
        if (gameState.nukes <= 0) return;
        gameState.nukes--;
        this.updateNukeUI();

        // ÊØÄÊªÖÊÄßÊ†∏ÂΩàË¶ñË¶∫ÊïàÊûú
        this.cameras.main.flash(500, 255, 255, 255);
        this.cameras.main.shake(500, 0.05);
        
        // Ê∏ÖÈô§ÊâÄÊúâÁï´Èù¢‰∏äÂ∞èÂÖµ
        this.enemies.getChildren().forEach(e => {
            this.add.particles(e.x, e.y, 'spark', { speed: 100, scale: { start: 1, end: 0 }, lifespan: 500, duration: 200 });
        });
        this.enemies.clear(true, true);

        // Â¶ÇÊûúÊòØ BossÔºåÊâ£Â§ßÈáèË°Ä
        if (this.boss) {
            this.boss.hp -= 30;
            this.updateBossHP();
        }
    }

    prepareBoss() {
        this.isBossTime = true;
        this.spawnTimer.remove();
        
        // ÁçéÂãµÊ†∏ÂΩà
        gameState.nukes = Math.min(gameState.nukes + 1, 5);
        this.updateNukeUI();
        
        const msg = this.add.text(225, 400, '‚ö†Ô∏è WARNING: BOSS APPEARING!', { fontSize: '32px', fill: '#ff0000', fontStyle: 'bold' }).setOrigin(0.5);
        this.tweens.add({ targets: msg, alpha: 0, duration: 500, yoyo: true, repeat: 3, onComplete: () => {
            msg.destroy();
            this.startBoss();
        }});
    }

    startBoss() {
        this.boss = this.physics.add.sprite(225, -100, 'nuke_icon').setScale(4).setTint(0x333333);
        this.boss.hp = 100;
        this.physics.add.existing(this.boss);
        
        // Boss ÂÖ•Â†¥
        this.tweens.add({ targets: this.boss, y: 150, duration: 2000, ease: 'Power2' });

        // Boss HP Ê¢ù
        this.hpBarBg = this.add.rectangle(225, 250, 300, 20, 0x666666);
        this.hpBar = this.add.rectangle(225, 250, 300, 20, 0xff0000);

        // Boss ÊîªÊìäÈÇèËºØ
        this.time.addEvent({
            delay: 2000,
            callback: () => {
                if (!this.boss || this.boss.hp <= 0) return;
                this.tweens.add({ targets: this.boss, x: Phaser.Math.Between(100, 350), duration: 1000 });
            },
            loop: true
        });

        this.physics.add.overlap(this.bullets, this.boss, (boss, bullet) => {
            bullet.destroy();
            this.boss.hp -= 1;
            this.updateBossHP();
        });
    }

    updateBossHP() {
        if (!this.boss) return;
        const width = Math.max(0, (this.boss.hp / 100) * 300);
        this.hpBar.width = width;

        if (this.boss.hp <= 0) {
            this.boss.destroy();
            this.hpBar.destroy();
            this.hpBarBg.destroy();
            this.add.text(225, 400, 'MISSION COMPLETE!', { fontSize: '48px', fill: '#f1c40f' }).setOrigin(0.5);
            this.time.delayedCall(3000, () => this.scene.start('SelectScene'));
        }
    }
}

</script>
</body>
</html>
