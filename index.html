// === 修改後：圖片資源管理 (含防呆機制) ===
const assets = {};
const imageSources = {
    player: { src: 'player.png', color: '#00f', w: 64, h: 64 },
    bulletPlayer: { src: 'bullet_player.png', color: '#0ff', w: 16, h: 32 },
    enemyMinion: { src: 'enemy_minion.png', color: '#f00', w: 48, h: 48 },
    enemyTurtle: { src: 'enemy_turtle.png', color: '#0f0', w: 64, h: 64 },
    bulletEnemy: { src: 'enemy_bullet.png', color: '#f0f', w: 24, h: 24 },
    boss: { src: 'boss.png', color: '#a00', w: 200, h: 150 },
    itemShield: { src: 'item_shield.png', color: '#3498db', w: 40, h: 40 },
    itemPower: { src: 'item_power.png', color: '#f1c40f', w: 40, h: 40 },
    bgSpace: { src: 'bg_space.png', color: '#111', w: 450, h: 800 },
    vfxShield: { src: 'vfx_shield.png', color: 'rgba(0,255,255,0.3)', w: 96, h: 96 }
};

let assetsLoaded = 0;
const totalAssets = Object.keys(imageSources).length;

function createPlaceholder(color, w, h) {
    const c = document.createElement('canvas');
    c.width = w; c.height = h;
    const x = c.getContext('2d');
    x.fillStyle = color;
    x.fillRect(0, 0, w, h);
    // 畫個 X 表示缺圖
    x.strokeStyle = '#fff'; x.lineWidth = 2;
    x.beginPath(); x.moveTo(0,0); x.lineTo(w,h); x.moveTo(w,0); x.lineTo(0,h); x.stroke();
    return c;
}

function loadAllAssets(callback) {
    for(let key in imageSources) {
        const data = imageSources[key];
        const img = new Image();
        
        // 成功載入
        img.onload = () => {
            assets[key] = img;
            checkDone();
        };
        
        // 失敗載入 (使用替代色塊，不讓遊戲卡住)
        img.onerror = () => {
            console.warn(`Missing file: ${data.src}, using placeholder.`);
            assets[key] = createPlaceholder(data.color, data.w, data.h);
            checkDone();
        };
        
        img.src = data.src;
    }
    
    function checkDone() {
        assetsLoaded++;
        // 顯示載入進度
        ui.loading.innerText = `LOADING... ${Math.floor((assetsLoaded/totalAssets)*100)}%`;
        
        if(assetsLoaded === totalAssets) {
            setTimeout(callback, 500); // 稍微停頓一下讓玩家看到 100%
        }
    }
}
// =======================
